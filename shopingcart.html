<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
        <a class="navbar-brand" href="#">E-Store</a>
    </div>
</nav>

<div class="container mt-4">
    <h2>Your Shopping Cart</h2>
    <table class="table table-bordered">
        <thead>
        <tr>
            <th>Product</th>
            <th>Price</th>
            <th>Quantity</th>
            <th>Subtotal</th>
            <th>Action</th>
        </tr>
        </thead>
        <tbody id="cart-items">
        <!-- Dynamically populated -->
        </tbody>
    </table>
    <div class="text-end">
        <h4>Total: LKR<span id="total-price">0.00</span></h4>
        <button class="btn btn-danger" onclick="clearCart()">Clear Cart</button>
        <button class="btn btn-success" onclick="checkout()">Checkout</button>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const token = localStorage.getItem("token");
        const userId = localStorage.getItem("id");

        const cartItemsContainer = document.getElementById("cart-items");
        const totalPriceElement = document.getElementById("total-price");

        function showError(message) {
            Swal.fire({
                title: "Error",
                text: message,
                icon: "error",
                confirmButtonColor: "#d33"
            });
        }

        function loadCart() {
            fetch(`http://localhost:8080/api/v1/cart/${userId}`, {
                headers: { Authorization: `Bearer ${token}` }
            })
                .then(response => response.json())
                .then(data => {
                    cartItemsContainer.innerHTML = "";
                    let total = 0;
                    data.forEach(item => {
                        const subtotal = item.product.price * item.quantity;
                        total += subtotal;
                        cartItemsContainer.innerHTML += `
              <tr>
                <td>${item.product.name}</td>
                <td>$${item.product.price}</td>
                <td><input type="number" value="${item.quantity}" class="form-control quantity-input" data-id="${item.id}"></td>
                <td>$${subtotal.toFixed(2)}</td>
                <td><button class="btn btn-danger btn-sm remove-btn" data-id="${item.id}">Remove</button></td>
              </tr>`;
                    });
                    totalPriceElement.textContent = total.toFixed(2);
                })
                .catch(error => {
                    console.error(error);
                    showError("Failed to load cart.");
                });
        }

        cartItemsContainer.addEventListener("change", (e) => {
            if (e.target.classList.contains("quantity-input")) {
                const id = e.target.dataset.id;
                const quantity = e.target.value;
                fetch(`http://localhost:8080/api/v1/cart/${id}/update?quantity=${quantity}`, {
                    method: "PUT",
                    headers: { Authorization: `Bearer ${token}` }
                })
                    .then(() => loadCart())
                    .catch(error => {
                        console.error(error);
                        showError("Failed to update quantity.");
                    });
            }
        });

        cartItemsContainer.addEventListener("click", (e) => {
            if (e.target.classList.contains("remove-btn")) {
                const id = e.target.dataset.id;
                fetch(`http://localhost:8080/api/v1/cart/${id}/remove`, {
                    method: "DELETE",
                    headers: { Authorization: `Bearer ${token}` }
                })
                    .then(() => loadCart())
                    .catch(error => {
                        console.error(error);
                        showError("Failed to remove item.");
                    });
            }
        });

        window.clearCart = () => {
            Swal.fire({
                title: "Clear Cart?",
                text: "All items will be removed.",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#d33",
                cancelButtonColor: "#3085d6",
                confirmButtonText: "Clear All"
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`http://localhost:8080/api/v1/cart/clear/${userId}`, {
                        method: "DELETE",
                        headers: { Authorization: `Bearer ${token}` }
                    })
                        .then(() => {
                            Swal.fire("Cleared", "Cart has been emptied.", "success");
                            loadCart();
                        })
                        .catch(error => {
                            console.error(error);
                            showError("Failed to clear cart.");
                        });
                }
            });
        };

        window.checkout = () => {
            const total = parseFloat(totalPriceElement.textContent);
            if (total > 0) {
                // Redirect to checkout page
                window.location.href = "checkout.html";
            } else {
                Swal.fire({
                    title: "Cart is Empty!",
                    text: "Add items to your cart before checking out.",
                    icon: "info",
                    confirmButtonColor: "#3085d6"
                });
            }
        };

        loadCart();
    });
</script>
</body>
</html>
